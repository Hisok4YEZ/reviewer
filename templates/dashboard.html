<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard â€“ FlashHotelReviewer</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <p style="text-align: right">
      ConnectÃ© en tant que {{ session.user_email }} |
      <a href="/logout">ğŸ”“ Se dÃ©connecter</a>
    </p>

    <div class="container">
      <h1>ğŸ“ Ã‰tablissements</h1>
      <ul>
        {% for loc in locations %}
        <li><strong>{{ loc.title }}</strong><br />{{ loc.locationName }}</li>
        {% endfor %}
      </ul>

      <h2>ğŸ“ Derniers avis</h2>
      {% for review in reviews %}
      <div
        class="review"
        style="
          background: #fff;
          padding: 15px;
          margin-bottom: 15px;
          border-radius: 10px;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        "
      >
        <div style="display: flex; align-items: center">
          <img
            src="{{ review.reviewer.profilePhotoUrl }}"
            alt="avatar"
            style="
              border-radius: 50%;
              width: 40px;
              height: 40px;
              margin-right: 10px;
            "
          />
          <strong>{{ review.reviewer.displayName }}</strong>
        </div>
        <p style="margin: 5px 0"><strong>â­ {{ review.starRating }}</strong></p>
        <p>{{ review.comment }}</p>
        <small style="color: gray">PostÃ© le {{ review.createTime[:10] }}</small>
      </div>
      <form
        method="POST"
        action="/generate_response"
        onsubmit="return genererReponse(this, event);"
      >
        <input type="hidden" name="avis" value="{{ review.comment }}" />
        <button type="submit">ğŸ§  GÃ©nÃ©rer une rÃ©ponse</button>
      </form>

      <div class="reponse-bloc" style="display: none; margin-top: 10px">
        <label><strong>RÃ©ponse gÃ©nÃ©rÃ©e :</strong></label
        ><br />
        <textarea
          class="zone-reponse"
          rows="4"
          style="width: 100%; margin-top: 5px"
        ></textarea
        ><br />
        <button type="button" class="copier-btn">ğŸ“‹ Copier la rÃ©ponse</button>
      </div>

      {% else %}
      <p>Aucun avis pour cet Ã©tablissement.</p>
      {% endfor %}
    </div>
    <h2>âš™ï¸ Configuration des rÃ©ponses</h2>
    <form action="/save_profile" method="post" style="margin-bottom: 30px">
      <label>Nom de lâ€™Ã©tablissement :</label><br />
      <input type="text" name="nom" required /><br /><br />

      <label>Type dâ€™Ã©tablissement :</label><br />
      <input
        type="text"
        name="type"
        placeholder="HÃ´tel, restaurantâ€¦"
        required
      /><br /><br />

      <label>Ville :</label><br />
      <input type="text" name="ville" required /><br /><br />

      <label>Ton souhaitÃ© :</label><br />
      <select name="ton" required>
        <option value="formel">Formel</option>
        <option value="amical">Amical</option>
        <option value="enthousiaste">Enthousiaste</option></select
      ><br /><br />

      <label>Signature personnalisÃ©e :</label><br />
      <input
        type="text"
        name="signature"
        placeholder="Lâ€™Ã©quipe de lâ€™HÃ´tel du Test"
      /><br /><br />

      <button type="submit">âœ… Enregistrer</button>
    </form>
    {% if session.profil_etablissement %}
    <h3>ğŸ§¾ Profil enregistrÃ© :</h3>
    <ul>
      <li><strong>Nom :</strong> {{ session.profil_etablissement.nom }}</li>
      <li><strong>Type :</strong> {{ session.profil_etablissement.type }}</li>
      <li><strong>Ville :</strong> {{ session.profil_etablissement.ville }}</li>
      <li><strong>Ton :</strong> {{ session.profil_etablissement.ton }}</li>
      <li>
        <strong>Signature :</strong> {{ session.profil_etablissement.signature
        }}
      </li>
    </ul>
    {% endif %}

    <script>
      function genererReponse(form, event) {
        event.preventDefault();

        const bloc = form.nextElementSibling;
        const textarea = bloc.querySelector(".zone-reponse");
        const boutonCopie = bloc.querySelector(".copier-btn");

        // Affiche le bloc
        bloc.style.display = "block";
        textarea.value = "â³ GÃ©nÃ©ration en cours...";
        boutonCopie.disabled = true;

        fetch("/generate_response", {
          method: "POST",
          body: new FormData(form),
        })
          .then((response) => response.text())
          .then((data) => {
            textarea.value = data;
            boutonCopie.disabled = false;
          })
          .catch((err) => {
            textarea.value = "âŒ Erreur : " + err;
            boutonCopie.disabled = true;
          });
      }

      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".copier-btn").forEach((button) => {
          button.addEventListener("click", () => {
            const textarea = button
              .closest(".reponse-bloc")
              .querySelector(".zone-reponse");
            navigator.clipboard.writeText(textarea.value).then(() => {
              button.innerText = "âœ… CopiÃ© !";
              setTimeout(() => {
                button.innerText = "ğŸ“‹ Copier la rÃ©ponse";
              }, 1500);
            });
          });
        });
      });
    </script>
  </body>
</html>
